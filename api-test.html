<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IA API Test</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Epilogue:wght@700;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0d0b1a;--s1:#13112a;--s2:#1a1635;
  --b1:rgba(255,255,255,.07);--b2:rgba(255,255,255,.13);
  --ac:#7c3aed;--ac2:#8b5cf6;--acd:rgba(124,58,237,.15);
  --gr:#22c55e;--rd:#ef4444;--am:#f59e0b;
  --tx:#ede9fe;--mu:#4c4a6b;--mu2:#6b6890;
  --mono:'DM Mono',monospace;--sans:'Epilogue',sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:var(--sans);background:var(--bg);color:var(--tx);
  min-height:100vh;display:flex;flex-direction:column;align-items:center;
  padding:2.5rem 1.5rem;}
.wrap{width:100%;max-width:600px;display:flex;flex-direction:column;gap:1.2rem;}
.ia-logo{height:22px;filter:brightness(0) invert(1);opacity:.7;margin-bottom:.25rem;}
h1{font-size:1.45rem;font-weight:900;letter-spacing:-.02em;}
.sub{font-size:.8rem;color:var(--mu2);line-height:1.55;margin-top:.2rem;}
.warn-box{background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.3);
  border-radius:.55rem;padding:.8rem 1rem;
  font-family:var(--mono);font-size:.7rem;line-height:1.65;color:var(--am);display:none;}
.card{background:var(--s1);border:1px solid var(--b1);border-radius:.7rem;padding:1.1rem 1.25rem;}
.card-head{display:flex;align-items:center;gap:.6rem;margin-bottom:.7rem;}
.card-icon{font-size:1.2rem;}
.card-title{font-size:.95rem;font-weight:700;}
.badge{font-family:var(--mono);font-size:.58rem;padding:.16rem .48rem;
  border-radius:2rem;background:var(--s2);border:1px solid var(--b2);
  color:var(--mu2);margin-left:auto;white-space:nowrap;}
.badge.pass{background:rgba(34,197,94,.1);border-color:rgba(34,197,94,.3);color:var(--gr);}
.badge.fail{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.3);color:var(--rd);}
.badge.running{background:var(--acd);border-color:rgba(139,92,246,.3);color:var(--ac2);}
.log{font-family:var(--mono);font-size:.7rem;line-height:1.8;
  background:var(--bg);border:1px solid var(--b1);border-radius:.38rem;
  padding:.7rem;min-height:44px;white-space:pre-wrap;word-break:break-all;
  max-height:160px;overflow-y:auto;}
.ok{color:var(--gr);}.err{color:var(--rd);}.info{color:var(--ac2);}
.warn{color:var(--am);}.mu{color:var(--mu2);}
.run-btn{font-family:var(--sans);font-size:.78rem;font-weight:700;
  padding:.45rem 1rem;border-radius:.32rem;
  border:1px solid var(--b2);background:var(--s2);
  color:var(--tx);cursor:pointer;margin-top:.6rem;transition:all .15s;}
.run-btn:hover{border-color:rgba(255,255,255,.2);}
.run-all{width:100%;font-family:var(--sans);font-size:.9rem;font-weight:700;
  padding:.65rem;border-radius:.42rem;border:none;
  background:var(--ac);color:#fff;cursor:pointer;transition:background .15s;}
.run-all:hover{background:var(--ac2);}
.summary{background:var(--s1);border:1px solid var(--b2);
  border-radius:.7rem;padding:1rem 1.25rem;display:none;}
.summary h3{font-size:.88rem;font-weight:700;margin-bottom:.5rem;}
.sum-line{font-family:var(--mono);font-size:.75rem;line-height:2;}
</style>
</head>
<body>
<div class="wrap">
  <img class="ia-logo" src="https://images.squarespace-cdn.com/content/v1/6021e9ddb0db996839eb2101/3dd21272-4acc-4995-880d-24b1600c28b8/Copy+of+IA+Logos.png?format=200w" alt="IA"/>
  <div>
    <h1>API Connectivity Test</h1>
    <div class="sub">Tests Firebase, GPT-4o, and Whisper. Run from Netlify â€” not a local file.</div>
  </div>
  <div class="warn-box" id="warnBox">
    You are opening this file directly from your computer (file://).<br>
    Browsers block API calls from local files. Open from Netlify instead:<br>
    https://mellifluous-lolly-73d1f7.netlify.app/api-test.html
  </div>
  <button class="run-all" onclick="runAll()">Run All Tests</button>
  <div class="card">
    <div class="card-head">
      <span class="card-icon">ðŸ”¥</span>
      <span class="card-title">Firebase Realtime Database</span>
      <span class="badge" id="fb-badge">Not run</span>
    </div>
    <div class="log" id="fb-log"><span class="mu">Press Run All Testsâ€¦</span></div>
    <button class="run-btn" onclick="testFirebase()">Run</button>
  </div>
  <div class="card">
    <div class="card-head">
      <span class="card-icon">ðŸ§ </span>
      <span class="card-title">OpenAI GPT-4o â€” Theme Extraction</span>
      <span class="badge" id="gpt-badge">Not run</span>
    </div>
    <div class="log" id="gpt-log"><span class="mu">Press Run All Testsâ€¦</span></div>
    <button class="run-btn" onclick="testGPT()">Run</button>
  </div>
  <div class="card">
    <div class="card-head">
      <span class="card-icon">ðŸŽ™</span>
      <span class="card-title">OpenAI Whisper â€” Transcription</span>
      <span class="badge" id="wh-badge">Not run</span>
    </div>
    <div class="log" id="wh-log"><span class="mu">Press Run All Testsâ€¦</span></div>
    <button class="run-btn" onclick="testWhisper()">Run</button>
  </div>
  <div class="summary" id="summary">
    <h3>Summary</h3>
    <div id="sumBody"></div>
  </div>
</div>

<script>
var OAI = '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';
var FB_CFG = {apiKey:'AIzaSyALhQTTwWLyXk4mVeckvbCuYjS1OS6RcZs',databaseURL:'https://ia-workshop-app-default-rtdb.firebaseio.com',projectId:'ia-workshop-app'};
var results = {firebase:null,gpt:null,whisper:null};
var fbApp = null;

if(location.protocol==='file:') document.getElementById('warnBox').style.display='block';

function addLog(id,msg,cls){
  var el=document.getElementById(id);
  var mu=el.querySelector('.mu');
  if(mu) el.innerHTML='';
  var s=document.createElement('span');
  if(cls) s.className=cls;
  s.textContent=msg+'\n';
  el.appendChild(s);
  el.scrollTop=el.scrollHeight;
}
function setBadge(id,state){
  var el=document.getElementById(id+'-badge');
  el.className='badge '+state;
  el.textContent=state==='pass'?'âœ“ Pass':state==='fail'?'âœ— Fail':state==='running'?'Runningâ€¦':state;
}
function xhrPost(url,headers,body){
  return new Promise(function(resolve,reject){
    var r=new XMLHttpRequest();
    r.open('POST',url);
    Object.keys(headers).forEach(function(k){r.setRequestHeader(k,headers[k]);});
    r.timeout=30000;
    r.onload=function(){resolve({status:r.status,text:r.responseText});};
    r.onerror=function(){reject(new Error('Network error â€” check WiFi connection'));};
    r.ontimeout=function(){reject(new Error('Timeout after 30s'));};
    r.send(body);
  });
}

function testFirebase(){
  setBadge('fb','running');
  addLog('fb-log','Initialising Firebaseâ€¦','info');
  try{
    if(!fbApp){
      try{fbApp=firebase.app('ia-test');}
      catch(e){fbApp=firebase.initializeApp(FB_CFG,'ia-test');}
    }
  }catch(e){
    addLog('fb-log','Failed to init: '+e.message,'err');
    setBadge('fb','fail');results.firebase=false;return;
  }
  var db=fbApp.database();
  addLog('fb-log','Writing test recordâ€¦','info');
  db.ref('_api_test').set({ok:true,ts:Date.now()}).then(function(){
    addLog('fb-log','  Write OK','ok');
    return db.ref('_api_test').once('value');
  }).then(function(snap){
    var val=snap.val();
    if(val&&val.ok){
      addLog('fb-log','  Read OK â€” '+JSON.stringify(val),'ok');
    }else{
      throw new Error('Unexpected read: '+JSON.stringify(val));
    }
    return db.ref('_api_test').remove();
  }).then(function(){
    addLog('fb-log','  Delete OK','ok');
    addLog('fb-log','\nFIREBASE PASSED','ok');
    setBadge('fb','pass');results.firebase=true;
  }).catch(function(e){
    addLog('fb-log','\nFAILED: '+e.message,'err');
    setBadge('fb','fail');results.firebase=false;
  });
}

function testGPT(){
  setBadge('gpt','running');
  addLog('gpt-log','Calling GPT-4oâ€¦','info');
  var body=JSON.stringify({model:'gpt-4o',max_tokens:80,temperature:0.3,
    messages:[{role:'user',content:'Return ONLY this JSON array: ["Distribution costs","Export access","Talent shortage"]'}]});
  xhrPost('https://api.openai.com/v1/chat/completions',
    {'Authorization':'Bearer '+OAI,'Content-Type':'application/json'},body)
  .then(function(res){
    if(res.status!==200) throw new Error('HTTP '+res.status+' '+res.text.slice(0,150));
    var data=JSON.parse(res.text);
    var content=(data.choices[0].message.content||'').trim();
    addLog('gpt-log','  Response: '+content,'ok');
    var themes=JSON.parse(content.replace(/```json|```/g,'').trim());
    addLog('gpt-log','  Themes: '+themes.join(', '),'ok');
    addLog('gpt-log','  Model: '+data.model+' | Tokens: '+data.usage.total_tokens,'mu');
    addLog('gpt-log','\nGPT-4o PASSED','ok');
    setBadge('gpt','pass');results.gpt=true;
  }).catch(function(e){
    addLog('gpt-log','\nFAILED: '+e.message,'err');
    setBadge('gpt','fail');results.gpt=false;
  });
}

function testWhisper(){
  setBadge('wh','running');
  addLog('wh-log','Generating 1-second test audioâ€¦','info');
  try{
    var sr=16000,ns=sr,buf=new ArrayBuffer(44+ns*2),v=new DataView(buf);
    function ws(o,s){for(var i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i));}
    ws(0,'RIFF');v.setUint32(4,36+ns*2,true);ws(8,'WAVE');
    ws(12,'fmt ');v.setUint32(16,16,true);v.setUint16(20,1,true);
    v.setUint16(22,1,true);v.setUint32(24,sr,true);v.setUint32(28,sr*2,true);
    v.setUint16(32,2,true);v.setUint16(34,16,true);ws(36,'data');v.setUint32(40,ns*2,true);
    for(var i=0;i<ns;i++) v.setInt16(44+i*2,Math.round(Math.sin(2*Math.PI*440*i/sr)*0.3*32767),true);
    var blob=new Blob([buf],{type:'audio/wav'});
    addLog('wh-log','  WAV: '+blob.size+' bytes','ok');
    addLog('wh-log','Sending to Whisperâ€¦','info');
    var fd=new FormData();
    fd.append('file',blob,'test.wav');
    fd.append('model','whisper-1');
    fd.append('language','en');
    var r=new XMLHttpRequest();
    r.open('POST','https://api.openai.com/v1/audio/transcriptions');
    r.setRequestHeader('Authorization','Bearer '+OAI);
    r.timeout=30000;
    r.onload=function(){
      if(r.status===200){
        var data=JSON.parse(r.responseText);
        addLog('wh-log','  HTTP 200 OK','ok');
        addLog('wh-log','  Transcript: "'+(data.text||'(empty â€” expected for tone)')+'"','ok');
        addLog('wh-log','\nWHISPER PASSED','ok');
        setBadge('wh','pass');results.whisper=true;
      }else{
        addLog('wh-log','\nFAILED: HTTP '+r.status+' '+r.responseText.slice(0,150),'err');
        setBadge('wh','fail');results.whisper=false;
      }
      showSummary();
    };
    r.onerror=function(){
      addLog('wh-log','\nFAILED: Network error â€” check WiFi','err');
      setBadge('wh','fail');results.whisper=false;
      showSummary();
    };
    r.ontimeout=function(){
      addLog('wh-log','\nFAILED: Timeout','err');
      setBadge('wh','fail');results.whisper=false;
      showSummary();
    };
    r.send(fd);
  }catch(e){
    addLog('wh-log','\nFAILED: '+e.message,'err');
    setBadge('wh','fail');results.whisper=false;
    showSummary();
  }
}

function showSummary(){
  var el=document.getElementById('summary');
  var body=document.getElementById('sumBody');
  el.style.display='block';
  function ic(v){return v===true?'âœ“':v===false?'âœ—':'â€”';}
  function cl(v){return v===true?'ok':v===false?'err':'mu';}
  var all=results.firebase===true&&results.gpt===true&&results.whisper===true;
  body.innerHTML=
    '<div class="sum-line"><span class="'+cl(results.firebase)+'">'+ic(results.firebase)+'  Firebase Realtime Database</span></div>'+
    '<div class="sum-line"><span class="'+cl(results.gpt)+'">'+ic(results.gpt)+'  OpenAI GPT-4o (theme extraction)</span></div>'+
    '<div class="sum-line"><span class="'+cl(results.whisper)+'">'+ic(results.whisper)+'  OpenAI Whisper (transcription)</span></div>'+
    '<div class="sum-line" style="margin-top:.35rem;"><span class="'+(all?'ok':'err')+'">'+(all?'All systems operational â€” ready for workshop.':'One or more tests failed â€” see logs above.')+'</span></div>';
}

function runAll(){
  document.getElementById('summary').style.display='none';
  results={firebase:null,gpt:null,whisper:null};
  testFirebase();
  setTimeout(function(){testGPT();},500);
  setTimeout(function(){testWhisper();},1200);
}
</script>
</body>
</html>
