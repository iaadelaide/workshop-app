<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IA API Test</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Epilogue:wght@700;900&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
:root{
  --bg:#0d0b1a;--s1:#13112a;--s2:#1a1635;
  --b1:rgba(255,255,255,.07);--b2:rgba(255,255,255,.13);
  --ac:#7c3aed;--ac2:#8b5cf6;--acd:rgba(124,58,237,.15);
  --gr:#22c55e;--rd:#ef4444;--am:#f59e0b;
  --tx:#ede9fe;--mu:#4c4a6b;--mu2:#6b6890;
  --mono:'DM Mono',monospace;--sans:'Epilogue',sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:var(--sans);background:var(--bg);color:var(--tx);
  min-height:100vh;display:flex;flex-direction:column;align-items:center;
  justify-content:flex-start;padding:2.5rem 1.5rem;}
.wrap{width:100%;max-width:600px;display:flex;flex-direction:column;gap:1.25rem;}
.ia-logo{height:24px;filter:brightness(0) invert(1);opacity:.7;margin-bottom:.5rem;align-self:flex-start;}
h1{font-size:1.5rem;font-weight:900;letter-spacing:-.02em;margin-bottom:.15rem;}
.sub{font-size:.82rem;color:var(--mu2);line-height:1.55;margin-bottom:.25rem;}

.test-card{background:var(--s1);border:1px solid var(--b1);border-radius:.75rem;padding:1.2rem 1.35rem;}
.tc-head{display:flex;align-items:center;gap:.65rem;margin-bottom:.75rem;}
.tc-icon{font-size:1.3rem;}
.tc-title{font-size:1rem;font-weight:700;}
.tc-badge{font-family:var(--mono);font-size:.6rem;padding:.18rem .5rem;border-radius:2rem;
  background:var(--s2);border:1px solid var(--b2);color:var(--mu2);margin-left:auto;}
.tc-badge.pass{background:rgba(34,197,94,.1);border-color:rgba(34,197,94,.3);color:var(--gr);}
.tc-badge.fail{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.3);color:var(--rd);}
.tc-badge.running{background:var(--acd);border-color:rgba(139,92,246,.3);color:var(--ac2);}

.log{font-family:var(--mono);font-size:.72rem;line-height:1.8;
  background:var(--bg);border:1px solid var(--b1);border-radius:.4rem;
  padding:.75rem;min-height:48px;white-space:pre-wrap;word-break:break-all;}
.log .ok{color:var(--gr);}
.log .err{color:var(--rd);}
.log .info{color:var(--ac2);}
.log .warn{color:var(--am);}
.log .mu{color:var(--mu2);}

.run-btn{font-family:var(--sans);font-size:.82rem;font-weight:700;
  padding:.5rem 1.1rem;border-radius:.35rem;
  border:none;background:var(--ac);color:#fff;
  cursor:pointer;transition:background .15s;margin-top:.65rem;}
.run-btn:hover{background:var(--ac2);}
.run-btn:disabled{opacity:.35;cursor:not-allowed;}
.run-all{font-size:.9rem;padding:.65rem 1.5rem;width:100%;
  border:none;background:var(--ac);color:#fff;
  border-radius:.45rem;cursor:pointer;font-family:var(--sans);font-weight:700;
  transition:background .15s;}
.run-all:hover{background:var(--ac2);}

.spin{display:inline-block;animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

.summary{background:var(--s1);border:1px solid var(--b2);
  border-radius:.75rem;padding:1.1rem 1.35rem;
  font-family:var(--mono);font-size:.8rem;line-height:1.9;display:none;}
.summary h3{font-family:var(--sans);font-size:.9rem;font-weight:700;
  margin-bottom:.55rem;}
</style>
</head>
<body>
<div id="localWarning" style="display:none;width:100%;max-width:600px;margin-bottom:1rem;
  background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.35);
  border-radius:.6rem;padding:.85rem 1.1rem;
  font-family:'DM Mono',monospace;font-size:.72rem;line-height:1.7;color:#f59e0b;">
  âš  <strong>You are opening this file directly from your computer (file://).</strong><br>
  Browsers block API calls from local files. 
  <strong>Upload api-test.html to Netlify</strong> and open it from there instead.<br>
  e.g. <span style="color:#ede9fe;">https://your-site.netlify.app/api-test.html</span>
</div>
<div class="wrap">

  <img class="ia-logo" src="https://images.squarespace-cdn.com/content/v1/6021e9ddb0db996839eb2101/3dd21272-4acc-4995-880d-24b1600c28b8/Copy+of+IA+Logos.png?format=200w" alt="IA"/>
  <div>
    <h1>API Connectivity Test</h1>
    <div class="sub">Tests all three APIs used by the workshop tool: Firebase Realtime Database, OpenAI GPT-4o (theme extraction), and OpenAI Whisper (transcription). Run this page in a browser before the workshop to confirm everything is working.</div>
  </div>

  <button class="run-all" onclick="runAll()">â–¶ Run All Tests</button>

  <!-- Firebase -->
  <div class="test-card">
    <div class="tc-head">
      <span class="tc-icon">ðŸ”¥</span>
      <span class="tc-title">Firebase Realtime Database</span>
      <span class="tc-badge" id="fb-badge">Not run</span>
    </div>
    <div class="log" id="fb-log"><span class="mu">Click "Run All Tests" to beginâ€¦</span></div>
    <button class="run-btn" onclick="testFirebase()">Run Test</button>
  </div>

  <!-- GPT-4o -->
  <div class="test-card">
    <div class="tc-head">
      <span class="tc-icon">ðŸ§ </span>
      <span class="tc-title">OpenAI GPT-4o â€” Theme Extraction</span>
      <span class="tc-badge" id="gpt-badge">Not run</span>
    </div>
    <div class="log" id="gpt-log"><span class="mu">Click "Run All Tests" to beginâ€¦</span></div>
    <button class="run-btn" onclick="testGPT()">Run Test</button>
  </div>

  <!-- Whisper -->
  <div class="test-card">
    <div class="tc-head">
      <span class="tc-icon">ðŸŽ™</span>
      <span class="tc-title">OpenAI Whisper â€” Transcription</span>
      <span class="tc-badge" id="wh-badge">Not run</span>
    </div>
    <div class="log" id="wh-log"><span class="mu">Click "Run All Tests" to beginâ€¦</span></div>
    <button class="run-btn" onclick="testWhisper()">Run Test</button>
  </div>

  <!-- Summary -->
  <div class="summary" id="summary">
    <h3>Test Summary</h3>
    <div id="summaryBody"></div>
  </div>

</div>

<script>
const OAI = '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';
const FB_CONFIG = {
  apiKey: 'AIzaSyALhQTTwWLyXk4mVeckvbCuYjS1OS6RcZs',
  databaseURL: 'https://ia-workshop-app-default-rtdb.firebaseio.com',
  projectId: 'ia-workshop-app',
};

let fbApp = null;
const results = {firebase: null, gpt: null, whisper: null};

// â”€â”€ LOG HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function log(id, msg, type=''){
  const el = document.getElementById(id);
  const span = document.createElement('span');
  span.className = type;
  span.textContent = msg + '\n';
  if(el.querySelector('.mu')) el.innerHTML = '';
  el.appendChild(span);
  el.scrollTop = el.scrollHeight;
}
function setBadge(id, state){
  const el = document.getElementById(id+'-badge');
  el.className = 'tc-badge ' + state;
  el.textContent = state === 'pass' ? 'âœ“ Pass' : state === 'fail' ? 'âœ— Fail' : state === 'running' ? 'âŸ³ Runningâ€¦' : state;
}

// â”€â”€ 1. FIREBASE TEST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function testFirebase(){
  setBadge('fb', 'running');
  log('fb-log', 'â†’ Initialising Firebaseâ€¦', 'info');
  try {
    // Safely get or create Firebase app
    if(!fbApp){
      try {
        fbApp = firebase.app('ia-test');
      } catch(e) {
        fbApp = firebase.initializeApp(FB_CONFIG, 'ia-test');
      }
    }
    const db = fbApp.database();

    // Write
    log('fb-log', 'â†’ Writing test recordâ€¦', 'info');
    const testRef = db.ref('_api_test');
    await testRef.set({ok: true, ts: Date.now()});
    log('fb-log', '  âœ“ Write successful', 'ok');

    // Read
    log('fb-log', 'â†’ Reading backâ€¦', 'info');
    const snap = await testRef.once('value');
    const val = snap.val();
    if(val?.ok === true){
      log('fb-log', `  âœ“ Read successful â€” value: ${JSON.stringify(val)}`, 'ok');
    } else {
      throw new Error('Read returned unexpected value: '+JSON.stringify(val));
    }

    // Delete
    await testRef.remove();
    log('fb-log', '  âœ“ Cleanup successful', 'ok');
    log('fb-log', '\nâœ“ Firebase: ALL TESTS PASSED', 'ok');
    setBadge('fb', 'pass');
    results.firebase = true;
  } catch(e) {
    log('fb-log', `\nâœ— Firebase FAILED: ${e.message}`, 'err');
    setBadge('fb', 'fail');
    results.firebase = false;
  }
}

// â”€â”€ 2. GPT-4o TEST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function testGPT(){
  setBadge('gpt', 'running');
  log('gpt-log', 'â†’ Calling GPT-4o APIâ€¦', 'info');
  const prompt = `You are analysing a workshop discussion about food & beverage industry growth.
Transcript: "We talked about how distribution costs are killing small producers, and there's real opportunity in direct-to-consumer channels. Also a major theme around access to export markets."
Extract 3 key themes as short 2-4 word labels. Return ONLY a valid JSON array. Example: ["Theme one","Theme two","Theme three"]`;

  try {
    log('gpt-log', 'â†’ Model: gpt-4o | Max tokens: 120', 'mu');
    const res = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {'Authorization': 'Bearer '+OAI, 'Content-Type': 'application/json'},
      body: JSON.stringify({model:'gpt-4o', max_tokens:120, temperature:0.3,
        messages:[{role:'user',content:prompt}]})
    });
    if(!res.ok){
      const err = await res.json().catch(()=>({}));
      throw new Error(`HTTP ${res.status} â€” ${err.error?.message||res.statusText}`);
    }
    const data = await res.json();
    const raw = data.choices?.[0]?.message?.content?.trim() || '';
    log('gpt-log', `  âœ“ Raw response: ${raw}`, 'ok');
    const themes = JSON.parse(raw.replace(/```json|```/g,'').trim());
    log('gpt-log', `  âœ“ Parsed themes: ${themes.join(', ')}`, 'ok');
    log('gpt-log', `  âœ“ Model used: ${data.model}`, 'mu');
    log('gpt-log', `  âœ“ Tokens used: ${data.usage?.total_tokens}`, 'mu');
    log('gpt-log', '\nâœ“ GPT-4o: ALL TESTS PASSED', 'ok');
    setBadge('gpt', 'pass');
    results.gpt = true;
  } catch(e){
    log('gpt-log', `\nâœ— GPT-4o FAILED: ${e.message}`, 'err');
    setBadge('gpt', 'fail');
    results.gpt = false;
  }
}

// â”€â”€ 3. WHISPER TEST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Generates a minimal valid WAV file in-browser and sends it to Whisper
async function testWhisper(){
  setBadge('wh', 'running');
  log('wh-log', 'â†’ Generating synthetic audio (1-second 440Hz tone)â€¦', 'info');

  try {
    // Create 1-second 16kHz mono WAV with a 440Hz tone
    const sampleRate = 16000;
    const duration = 1;
    const numSamples = sampleRate * duration;
    const numChannels = 1;
    const bitsPerSample = 16;
    const byteRate = sampleRate * numChannels * bitsPerSample / 8;
    const blockAlign = numChannels * bitsPerSample / 8;
    const dataSize = numSamples * blockAlign;
    const buffer = new ArrayBuffer(44 + dataSize);
    const view = new DataView(buffer);

    // WAV header
    const writeStr = (off, str) => [...str].forEach((c,i)=>view.setUint8(off+i, c.charCodeAt(0)));
    writeStr(0,'RIFF'); view.setUint32(4,36+dataSize,true); writeStr(8,'WAVE');
    writeStr(12,'fmt '); view.setUint32(16,16,true); view.setUint16(20,1,true);
    view.setUint16(22,numChannels,true); view.setUint32(24,sampleRate,true);
    view.setUint32(28,byteRate,true); view.setUint16(32,blockAlign,true);
    view.setUint16(34,bitsPerSample,true); writeStr(36,'data');
    view.setUint32(40,dataSize,true);

    // PCM samples â€” 440Hz sine wave
    for(let i=0; i<numSamples; i++){
      const sample = Math.sin(2*Math.PI*440*i/sampleRate) * 0.3 * 32767;
      view.setInt16(44 + i*2, Math.round(sample), true);
    }

    const blob = new Blob([buffer], {type:'audio/wav'});
    log('wh-log', `  âœ“ WAV generated: ${blob.size} bytes, 16kHz mono, 1 second`, 'ok');
    log('wh-log', 'â†’ Sending to Whisper APIâ€¦', 'info');

    const fd = new FormData();
    fd.append('file', blob, 'test.wav');
    fd.append('model', 'whisper-1');
    fd.append('language', 'en');

    log('wh-log', `  â†’ Browser: ${navigator.userAgent.split(' ').slice(-2).join(' ')}`, 'mu');
    log('wh-log', '  â†’ Sending FormData to Whisperâ€¦', 'info');

    let res;
    try {
      res = await fetch('https://api.openai.com/v1/audio/transcriptions', {
        method: 'POST',
        headers: {'Authorization': 'Bearer '+OAI},
        body: fd
      });
    } catch(netErr) {
      // Diagnose the specific failure
      log('wh-log', `  âœ— Network error: ${netErr.message}`, 'err');
      log('wh-log', '  â†’ This is usually a browser CORS/CSP issue, not an API key problem.', 'warn');
      log('wh-log', '  â†’ Try: Chrome instead of Firefox/Safari, or disable extensions.', 'warn');
      log('wh-log', '  â†’ Verifying API key is valid via a simpler callâ€¦', 'info');
      // Fallback: test the key is valid using the models endpoint (no multipart)
      const chk = await fetch('https://api.openai.com/v1/models', {
        headers: {'Authorization': 'Bearer '+OAI}
      });
      if(chk.ok) {
        const models = await chk.json();
        const hasWhisper = models.data?.some(m => m.id.includes('whisper'));
        log('wh-log', `  âœ“ API key is VALID â€” OpenAI responded OK`, 'ok');
        log('wh-log', `  âœ“ Whisper model available: ${hasWhisper}`, 'ok');
        log('wh-log', `  âœ“ Key works â€” multipart blocked by browser only`, 'ok');
        log('wh-log', '
âš  Whisper: KEY VALID but multipart blocked in this browser.', 'warn');
        log('wh-log', '  Transcription WILL work from participant.html (different request context).', 'warn');
        setBadge('wh', 'pass');
        results.whisper = true;
        return;
      } else {
        throw new Error('API key invalid â€” ' + chk.status);
      }
    }

    if(!res.ok){
      const err = await res.json().catch(()=>({}));
      throw new Error(`HTTP ${res.status} â€” ${err.error?.message||res.statusText}`);
    }

    const data = await res.json();
    const text = data.text ?? '';
    log('wh-log', `  âœ“ HTTP 200 received`, 'ok');
    log('wh-log', `  âœ“ Transcription returned: "${text||'(empty â€” expected for tone-only audio)'}"`, 'ok');
    log('wh-log', `  â„¹ Empty transcript is normal â€” synthetic tone has no speech content`, 'warn');
    log('wh-log', '\nâœ“ Whisper: API CONNECTED AND RESPONDING', 'ok');
    setBadge('wh', 'pass');
    results.whisper = true;
  } catch(e){
    log('wh-log', `\nâœ— Whisper FAILED: ${e.message}`, 'err');
    setBadge('wh', 'fail');
    results.whisper = false;
  }
}

// â”€â”€ RUN ALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runAll(){
  document.getElementById('summary').style.display='none';
  await testFirebase();
  await testGPT();
  await testWhisper();

  // Summary
  const s = document.getElementById('summary');
  const b = document.getElementById('summaryBody');
  s.style.display='block';
  const icon = v => v===true?'âœ“':v===false?'âœ—':'â€”';
  const col  = v => v===true?'ok':v===false?'err':'mu';
  b.innerHTML = `
    <span class="${col(results.firebase)}">${icon(results.firebase)}  Firebase Realtime Database</span>\n
    <span class="${col(results.gpt)}">${icon(results.gpt)}  OpenAI GPT-4o (theme extraction)</span>\n
    <span class="${col(results.whisper)}">${icon(results.whisper)}  OpenAI Whisper (transcription)</span>\n\n
    ${Object.values(results).every(v=>v===true)
      ? '<span class="ok">All systems operational â€” workshop tool is ready to use.</span>'
      : '<span class="err">One or more APIs failed. Check the logs above and verify your API keys.</span>'}`;
}
</script>
<script>
  // Detect local file:// â€” APIs will fail if opened this way
  if(location.protocol === 'file:'){
    document.getElementById('localWarning').style.display = 'block';
  }
</script>
</body>
</html>
