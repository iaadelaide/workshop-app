<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IA Workshop Control</title>
<link rel="icon" type="image/png" href="https://images.squarespace-cdn.com/content/v1/6021e9ddb0db996839eb2101/3dd21272-4acc-4995-880d-24b1600c28b8/Copy+of+IA+Logos.png?format=100w"/>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Epilogue:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0d0b1a; --s1:#13112a; --s2:#1a1635; --s3:#211e40;
  --b1:rgba(255,255,255,.07); --b2:rgba(255,255,255,.13);
  --ac:#7c3aed; --ac2:#8b5cf6; --acd:rgba(124,58,237,.15);
  --gr:#22c55e; --grd:rgba(34,197,94,.1);
  --rd:#ef4444; --rdd:rgba(239,68,68,.1);
  --am:#f59e0b;
  --tx:#ede9fe; --mu:#4c4a6b; --mu2:#6b6890;
  --mono:'DM Mono',monospace; --sans:'Epilogue',sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;}
body{font-family:var(--sans);background:var(--bg);color:var(--tx);
  display:grid;grid-template-rows:52px 1fr;}

/* TOPBAR */
.topbar{display:flex;align-items:center;gap:.8rem;padding:0 1.2rem;
  border-bottom:1px solid var(--b1);background:rgba(13,11,26,.97);
  backdrop-filter:blur(16px);z-index:20;}
.ia-logo{height:22px;object-fit:contain;filter:brightness(0) invert(1);opacity:.85;}
.tb-div{width:1px;height:16px;background:var(--b2);}
.topbar h1{font-size:.88rem;font-weight:700;}
.tb-badge{font-family:var(--mono);font-size:.58rem;padding:.18rem .5rem;
  border-radius:.22rem;background:var(--acd);color:var(--ac2);
  border:1px solid rgba(139,92,246,.25);letter-spacing:.1em;}
.tb-right{margin-left:auto;display:flex;align-items:center;gap:.7rem;}
.live-badge{display:none;align-items:center;gap:.35rem;
  font-family:var(--mono);font-size:.63rem;color:var(--rd);}
.live-badge.show{display:flex;}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--rd);animation:blink 1s infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:.25;}}
.conn-pill{font-family:var(--mono);font-size:.62rem;color:var(--mu2);
  display:flex;align-items:center;gap:.32rem;}
.cdot{width:6px;height:6px;border-radius:50%;background:var(--mu);}
.cdot.on{background:var(--gr);box-shadow:0 0 5px var(--gr);}

/* SHELL */
.shell{display:grid;grid-template-columns:250px 1fr 270px;overflow:hidden;height:100%;}

/* LEFT */
.left{display:flex;flex-direction:column;border-right:1px solid var(--b1);
  background:var(--s1);overflow-y:auto;}
.left::-webkit-scrollbar{width:3px;}
.left::-webkit-scrollbar-thumb{background:var(--b2);}
.blk{padding:.85rem 1rem;border-bottom:1px solid var(--b1);}
.lbl{font-family:var(--mono);font-size:.57rem;text-transform:uppercase;
  letter-spacing:.13em;color:var(--mu2);margin-bottom:.42rem;}

.sess-code{font-family:var(--mono);font-size:1.8rem;font-weight:500;
  color:var(--ac2);letter-spacing:.12em;line-height:1;}
.sess-url{font-family:var(--mono);font-size:.58rem;color:var(--mu2);
  margin-top:.32rem;line-height:1.55;word-break:break-all;}
.sess-url a{color:var(--ac2);text-decoration:none;}
.sess-url a:hover{text-decoration:underline;}

/* Phase list */
.phase-item{padding:.55rem .65rem;border-radius:.35rem;border:1px solid var(--b1);
  background:var(--s2);margin-bottom:.28rem;cursor:pointer;transition:all .15s;}
.phase-item:hover{border-color:var(--b2);}
.phase-item.active{border-color:var(--ac);background:var(--acd);}
.phase-item.done{opacity:.38;}
.pi-top{display:flex;align-items:center;gap:.4rem;margin-bottom:.18rem;}
.pi-num{width:18px;height:18px;border-radius:50%;
  background:var(--s3);border:1px solid var(--b2);
  font-family:var(--mono);font-size:.6rem;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.phase-item.active .pi-num{background:var(--ac);border-color:var(--ac);color:#fff;}
.phase-item.done .pi-num{background:var(--grd);border-color:rgba(34,197,94,.3);color:var(--gr);}
.pi-dur{font-family:var(--mono);font-size:.56rem;color:var(--mu2);margin-left:auto;}
.pi-badge{font-family:var(--mono);font-size:.54rem;padding:.1rem .36rem;border-radius:.18rem;}
.pi-badge.live{background:var(--rdd);color:var(--rd);border:1px solid rgba(239,68,68,.25);}
.pi-badge.done{background:var(--grd);color:var(--gr);border:1px solid rgba(34,197,94,.25);}
.pi-badge.pending{background:var(--s3);color:var(--mu2);border:1px solid var(--b1);}
.pi-sess{font-family:var(--mono);font-size:.54rem;color:var(--mu2);margin-bottom:.14rem;letter-spacing:.05em;}
.pi-text{font-size:.7rem;font-weight:600;line-height:1.3;
  display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.pi-type{font-family:var(--mono);font-size:.52rem;color:var(--mu);margin-top:.12rem;}

/* Timer */
.timer-big{font-family:var(--mono);font-size:2.5rem;font-weight:500;
  color:var(--ac2);line-height:1;margin-bottom:.45rem;transition:color .3s;}
.timer-big.warn{color:var(--am);}
.timer-big.crit{color:var(--rd);animation:flicker .8s infinite;}
@keyframes flicker{0%,100%{opacity:1;}50%{opacity:.55;}}
.t-prog{height:3px;background:var(--b1);border-radius:2px;margin-bottom:.55rem;overflow:hidden;}
.t-bar{height:100%;background:var(--ac2);transition:width 1s linear;box-shadow:0 0 7px var(--ac);}
.t-ctrl{display:flex;gap:.35rem;flex-wrap:wrap;}

/* Tables */
.tgrid{display:grid;grid-template-columns:1fr 1fr;gap:.35rem;margin-top:.38rem;}
.tc{border:1px solid var(--b1);border-radius:.35rem;padding:.45rem .55rem;
  background:var(--s2);display:flex;align-items:center;gap:.4rem;transition:all .2s;}
.tc.conn{border-color:rgba(124,58,237,.35);background:var(--acd);}
.tc.rec{border-color:rgba(239,68,68,.45);background:var(--rdd);animation:rb 1.5s infinite;}
@keyframes rb{0%,100%{border-color:rgba(239,68,68,.4);}50%{border-color:rgba(239,68,68,.9);}}
.tc-n{font-family:var(--mono);font-size:.8rem;font-weight:500;}
.tc-s{font-family:var(--mono);font-size:.54rem;text-transform:uppercase;letter-spacing:.05em;color:var(--mu2);}
.tc.rec .tc-s{color:var(--rd);}
.tc.conn .tc-s{color:var(--ac2);}
.tc-ct{font-family:var(--mono);font-size:.6rem;color:var(--mu2);margin-top:.4rem;}

/* BTNs */
.btn{font-family:var(--sans);font-size:.72rem;font-weight:600;
  padding:.36rem .78rem;border-radius:.32rem;
  border:1px solid var(--b2);background:var(--s2);
  color:var(--tx);cursor:pointer;transition:all .15s;white-space:nowrap;}
.btn:hover{background:var(--s3);border-color:rgba(255,255,255,.18);}
.btn.pri{background:var(--ac);border-color:var(--ac);color:#fff;}
.btn.pri:hover{background:var(--ac2);}
.btn.dng{background:var(--rdd);border-color:rgba(239,68,68,.3);color:var(--rd);}
.btn.full{width:100%;text-align:center;display:block;}
.btn:disabled{opacity:.35;cursor:not-allowed;}
.row{display:flex;gap:.35rem;flex-wrap:wrap;margin-top:.55rem;}

/* IA footer */
.ia-foot{padding:.75rem 1rem;margin-top:auto;border-top:1px solid var(--b1);
  display:flex;align-items:center;gap:.45rem;}
.ia-foot img{height:14px;object-fit:contain;filter:brightness(0) invert(1);opacity:.27;}
.ia-foot span{font-family:var(--mono);font-size:.57rem;color:var(--mu);letter-spacing:.05em;}

/* CENTRE */
.centre{display:flex;flex-direction:column;overflow:hidden;}

/* Phase header */
.phase-header{padding:.8rem 1.1rem;border-bottom:1px solid var(--b1);
  background:var(--s1);flex-shrink:0;}
.ph-top{display:flex;align-items:center;gap:.6rem;margin-bottom:.38rem;}
.ph-tag{font-family:var(--mono);font-size:.58rem;text-transform:uppercase;
  letter-spacing:.1em;color:var(--ac2);background:var(--acd);
  border:1px solid rgba(139,92,246,.22);padding:.16rem .48rem;border-radius:2rem;}
.ph-type-tag{font-family:var(--mono);font-size:.58rem;padding:.16rem .48rem;
  border-radius:2rem;border:1px solid var(--b2);color:var(--mu2);}
.ph-type-tag.discuss{border-color:rgba(34,197,94,.3);color:var(--gr);background:var(--grd);}
.ph-type-tag.reportback{border-color:rgba(245,158,11,.3);color:var(--am);background:rgba(245,158,11,.1);}
.ph-type-tag.synthesis{border-color:rgba(139,92,246,.3);color:var(--ac2);background:var(--acd);}
.ph-text{font-size:1.05rem;font-weight:700;line-height:1.3;letter-spacing:-.01em;}

/* Stage area */
.stage{flex:1;overflow-y:auto;padding:.8rem;}
.stage::-webkit-scrollbar{width:3px;}
.stage::-webkit-scrollbar-thumb{background:var(--b2);}

/* Table panels (2x2 grid) */
.stage.grid4{display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;gap:.65rem;}

/* Report-back full overlay */
.stage.rb-view{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1.1rem;text-align:center;}
.rb-icon{font-size:2.8rem;}
.rb-title{font-size:1.5rem;font-weight:900;letter-spacing:-.02em;}
.rb-desc{font-family:var(--mono);font-size:.78rem;color:var(--mu2);line-height:1.75;max-width:500px;}
.rb-prompts{display:flex;flex-direction:column;gap:.5rem;margin-top:.5rem;max-width:520px;width:100%;}
.rb-prompt-item{background:var(--s1);border:1px solid rgba(245,158,11,.2);
  border-radius:.5rem;padding:.75rem 1rem;text-align:left;
  display:flex;align-items:flex-start;gap:.65rem;}
.rb-prompt-num{font-family:var(--mono);font-size:.65rem;color:var(--am);
  background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.25);
  padding:.15rem .42rem;border-radius:.22rem;flex-shrink:0;margin-top:.1rem;}
.rb-prompt-text{font-size:.82rem;font-weight:600;line-height:1.4;}

/* Synthesis view */
.stage.synth-view{display:flex;flex-direction:column;gap:1rem;padding:1.1rem;}
.synth-section{background:var(--s1);border:1px solid var(--b2);border-radius:.6rem;padding:1rem 1.1rem;}
.synth-section h3{font-family:var(--mono);font-size:.6rem;text-transform:uppercase;
  letter-spacing:.12em;color:var(--ac2);margin-bottom:.65rem;}
.synth-themes{display:flex;flex-wrap:wrap;gap:.35rem;margin-bottom:.65rem;}
.synth-tag{font-family:var(--mono);font-size:.63rem;padding:.2rem .52rem;border-radius:2rem;
  background:var(--acd);color:var(--ac2);border:1px solid rgba(139,92,246,.22);}
.synth-tx{font-size:.78rem;color:rgba(237,233,254,.65);line-height:1.6;
  font-style:italic;border-left:2px solid var(--b2);padding-left:.75rem;
  margin-top:.35rem;}
.synth-btn-row{display:flex;gap:.5rem;margin-top:.75rem;}
.synth-output{background:var(--bg);border:1px solid var(--b2);border-radius:.4rem;
  padding:.85rem;font-size:.78rem;line-height:1.7;color:rgba(237,233,254,.8);
  white-space:pre-wrap;margin-top:.65rem;max-height:300px;overflow-y:auto;display:none;}
.synth-output::-webkit-scrollbar{width:3px;}
.synth-output::-webkit-scrollbar-thumb{background:var(--b2);}
.spin{display:inline-block;animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* Table panel */
.tp{background:var(--s1);border:1px solid var(--b1);border-radius:.55rem;
  display:flex;flex-direction:column;overflow:hidden;transition:border-color .25s;min-height:0;}
.tp.has{border-color:rgba(139,92,246,.28);}
.tp.rec{border-color:rgba(239,68,68,.4);}
.tp-head{display:flex;align-items:center;gap:.5rem;
  padding:.55rem .75rem;border-bottom:1px solid var(--b1);flex-shrink:0;}
.tp-tag{font-family:var(--mono);font-size:.62rem;color:var(--ac2);background:var(--acd);
  border:1px solid rgba(139,92,246,.18);padding:.16rem .45rem;border-radius:.2rem;}
.tp-name{font-size:.72rem;font-weight:600;flex:1;}
.tp-rdot{width:5px;height:5px;border-radius:50%;background:var(--rd);
  animation:blink 1s infinite;display:none;}
.tp.rec .tp-rdot{display:block;}
.tp-ts{font-family:var(--mono);font-size:.56rem;color:var(--mu2);}
.tp-body{flex:1;overflow-y:auto;padding:.65rem .75rem;
  display:flex;flex-direction:column;gap:.5rem;}
.tp-body::-webkit-scrollbar{width:3px;}
.tp-body::-webkit-scrollbar-thumb{background:var(--b2);}
.theme-row{display:flex;flex-wrap:wrap;gap:.28rem;}
.ttag{font-family:var(--mono);font-size:.6rem;padding:.2rem .5rem;border-radius:2rem;
  background:var(--acd);color:var(--ac2);border:1px solid rgba(139,92,246,.2);
  animation:tin .3s ease;}
@keyframes tin{from{opacity:0;transform:scale(.85);}to{opacity:1;transform:scale(1);}}
.gen{font-family:var(--mono);font-size:.6rem;color:var(--mu2);
  display:flex;align-items:center;gap:.32rem;}
.tp-tx{font-size:.72rem;line-height:1.6;color:rgba(237,233,254,.58);
  border-top:1px solid var(--b1);padding-top:.42rem;
  max-height:65px;overflow:hidden;position:relative;transition:max-height .3s;}
.tp-tx.exp{max-height:300px;}
.tp-tx:not(.exp)::after{content:'';position:absolute;bottom:0;left:0;right:0;
  height:20px;background:linear-gradient(transparent,var(--s1));pointer-events:none;}
.tp-more{font-family:var(--mono);font-size:.56rem;color:var(--ac2);
  cursor:pointer;background:none;border:none;padding:.18rem 0;display:block;}
.tp-more:hover{text-decoration:underline;}
.tp-empty{flex:1;display:flex;flex-direction:column;align-items:center;
  justify-content:center;gap:.3rem;color:var(--mu);padding:.65rem;}
.tp-empty .ico{font-size:1.2rem;opacity:.25;}
.tp-empty p{font-size:.67rem;text-align:center;line-height:1.45;max-width:130px;}

/* RIGHT */
.right{display:flex;flex-direction:column;border-left:1px solid var(--b1);
  background:var(--s1);overflow-y:auto;}
.right::-webkit-scrollbar{width:3px;}
.right::-webkit-scrollbar-thumb{background:var(--b2);}
.rs{padding:.85rem 1rem;border-bottom:1px solid var(--b1);}
.rs h3{font-family:var(--mono);font-size:.57rem;text-transform:uppercase;
  letter-spacing:.12em;color:var(--mu2);margin-bottom:.65rem;}
.cluster{margin-bottom:.6rem;}
.cluster-name{font-size:.78rem;font-weight:700;margin-bottom:.22rem;
  display:flex;align-items:center;gap:.42rem;}
.cluster-ct{font-family:var(--mono);font-size:.58rem;color:var(--mu2);}
.cluster-tabs{display:flex;gap:.25rem;flex-wrap:wrap;}
.ctbadge{font-family:var(--mono);font-size:.56rem;padding:.1rem .38rem;
  border-radius:.2rem;background:var(--s3);border:1px solid var(--b2);color:var(--mu2);}
.no-data{font-size:.72rem;color:var(--mu);line-height:1.6;}
</style>
</head>
<body>

<header class="topbar">
  <img class="ia-logo" src="https://images.squarespace-cdn.com/content/v1/6021e9ddb0db996839eb2101/3dd21272-4acc-4995-880d-24b1600c28b8/Copy+of+IA+Logos.png?format=200w" alt="IA" onerror="this.style.display='none'"/>
  <div class="tb-div"></div>
  <h1>Workshop Control</h1>
  <span class="tb-badge">FACILITATOR</span>
  <div class="tb-right">
    <div class="live-badge" id="liveBadge"><div class="live-dot"></div><span id="liveLabel">LIVE</span></div>
    <div class="conn-pill"><div class="cdot" id="connDot"></div><span id="connLabel">Connectingâ€¦</span></div>
  </div>
</header>

<div class="shell">

  <!-- LEFT -->
  <div class="left">

    <div class="blk">
      <div class="lbl">Session Code</div>
      <div class="sess-code" id="sessCode">â€”â€”â€”â€”â€”â€”</div>
      <div class="sess-url">Participant URL:<br><a id="sessUrl" href="#" target="_blank">â€”</a></div>
      <div class="row">
        <button class="btn" style="font-size:.66rem;padding:.3rem .65rem;" onclick="copyCode()">Copy Code</button>
        <button class="btn" style="font-size:.66rem;padding:.3rem .65rem;" onclick="copyURL()">Copy URL</button>
      </div>
    </div>

    <div class="blk">
      <div class="lbl">Phases</div>
      <div id="phaseList"></div>
    </div>

    <div class="blk">
      <div class="lbl">Timer</div>
      <div class="timer-big" id="timerBig">15:00</div>
      <div class="t-prog"><div class="t-bar" id="tBar" style="width:100%"></div></div>
      <div class="t-ctrl">
        <button class="btn pri" id="startBtn" onclick="toggleTimer()" disabled style="font-size:.7rem;padding:.33rem .75rem;">â–¶ Start</button>
        <button class="btn" onclick="resetTimer()" id="resetBtn" disabled style="font-size:.7rem;padding:.33rem .65rem;">â†º</button>
        <button class="btn" onclick="prevPhase()" id="prevBtn" disabled style="font-size:.7rem;padding:.33rem .6rem;">â—€</button>
        <button class="btn" onclick="nextPhase()" id="nextBtn" disabled style="font-size:.7rem;padding:.33rem .65rem;">Next â–¶</button>
      </div>
    </div>

    <div class="blk">
      <div class="lbl">Tables</div>
      <div class="tgrid">
        <div class="tc" id="tc1"><div class="tc-n">T1</div><div class="tc-s">â€”</div></div>
        <div class="tc" id="tc2"><div class="tc-n">T2</div><div class="tc-s">â€”</div></div>
        <div class="tc" id="tc3"><div class="tc-n">T3</div><div class="tc-s">â€”</div></div>
        <div class="tc" id="tc4"><div class="tc-n">T4</div><div class="tc-s">â€”</div></div>
      </div>
      <div class="tc-ct" id="tcCount">0 / 4 connected</div>
      <div style="margin-top:.6rem;display:flex;flex-direction:column;gap:.3rem;">
        <button class="btn pri full" id="launchBtn" onclick="startSession()">â–¶ Start Session</button>
        <button class="btn dng full" id="endBtn" onclick="endSession()" style="display:none;">â–  End Session</button>
      </div>
    </div>

    <div class="blk" style="border-bottom:none;">
      <div class="lbl">Export</div>
      <div style="display:flex;flex-direction:column;gap:.3rem;">
        <button class="btn full" style="font-size:.68rem;" onclick="exportAll()">â†“ All Transcripts (.txt)</button>
        <button class="btn full" style="font-size:.68rem;" onclick="exportThemes()">â†“ Theme Summary (.txt)</button>
      </div>
    </div>

    <div class="ia-foot">
      <img src="https://images.squarespace-cdn.com/content/v1/6021e9ddb0db996839eb2101/3dd21272-4acc-4995-880d-24b1600c28b8/Copy+of+IA+Logos.png?format=100w" alt="IA"/>
      <span>innovationarchitects.com.au</span>
    </div>

  </div>

  <!-- CENTRE -->
  <div class="centre">
    <div class="phase-header">
      <div class="ph-top">
        <span class="ph-tag" id="phTag">PHASE 1</span>
        <span class="ph-type-tag" id="phTypeTag">Discussion</span>
      </div>
      <div class="ph-text" id="phText">Start the session to begin.</div>
    </div>
    <div class="stage grid4" id="stage"></div>
  </div>

  <!-- RIGHT -->
  <div class="right">
    <div class="rs">
      <h3>ðŸ”— Shared Themes â€” Current Phase</h3>
      <div id="crossThemes"><div class="no-data">Themes appear here during discussion phases.</div></div>
    </div>
    <div class="rs">
      <h3>All Themes by Table</h3>
      <div id="byTable"><div class="no-data">No themes yet.</div></div>
    </div>
  </div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const FB={apiKey:'AIzaSyALhQTTwWLyXk4mVeckvbCuYjS1OS6RcZs',databaseURL:'https://ia-workshop-app-default-rtdb.firebaseio.com',projectId:'ia-workshop-app'};
const OAI='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';

// â”€â”€ PHASE DEFINITIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// type: 'discuss' | 'reportback' | 'synthesis'
// themes: true = extract themes + show on participant screens
// reportPrompts: bullet points spoken by spokesperson
const PHASES = [
  {
    id:1, label:'Phase 1', session:'Session 1', phase:'Group Discussion',
    text:'Where do we want to go?',
    dur:900, type:'discuss', themes:true,
    instruction:'Discuss as a table and record your conversation.',
  },
  {
    id:2, label:'Phase 2', session:'Session 1', phase:'Report Back',
    text:'Session 1 â€” Spokesperson Report Back',
    dur:300, type:'reportback', themes:false,
    instruction:'Each table spokesperson reports back to the room.',
    reportPrompts:[
      {num:'01', text:'One Future State Headline for 2040'},
      {num:'02', text:'Three defining features of that future'},
    ],
  },
  {
    id:3, label:'Phase 3', session:'Session 2', phase:'Group Discussion',
    text:'How do we get to the future state?',
    dur:900, type:'discuss', themes:true,
    instruction:'Discuss as a table and record your conversation.',
  },
  {
    id:4, label:'Phase 4', session:'Session 2', phase:'Report Back',
    text:'Session 2 â€” Spokesperson Report Back',
    dur:300, type:'reportback', themes:false,
    instruction:'Each table spokesperson reports back to the room.',
    reportPrompts:[
      {num:'01', text:'Priority shifts needed'},
      {num:'02', text:'Key actors responsible for implementation'},
      {num:'03', text:'Where can Queensland Government play a role?'},
    ],
  },
  {
    id:5, label:'Phase 5', session:'Synthesis', phase:'Collective Themes',
    text:'Facilitator presents collective insights across all tables',
    dur:0, type:'synthesis', themes:false,
    instruction:'Use the synthesis panel to generate and present collective insights.',
  },
];

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let db=null,ref=null,code='',curP=0,running=false,tInt=null,secs=900,live=false;
// tdata[tableNum][phaseIdx] = {transcripts:[], themes:[], generating:false}
const tdata={1:{},2:{},3:{},4:{}};
let allTx=[];

// â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('load',async()=>{
  firebase.initializeApp(FB); db=firebase.database();
  db.ref('.info/connected').on('value',s=>setConn(s.val()));
  code=gc(); ref=db.ref('sessions/'+code);
  await ref.set({code,status:'waiting',currentPhase:0,timerRunning:false,
    secondsLeft:PHASES[0].dur,phases:PHASES,createdAt:firebase.database.ServerValue.TIMESTAMP});
  const url=`${location.origin}/participant.html?session=${code}`;
  document.getElementById('sessCode').textContent=code;
  const a=document.getElementById('sessUrl'); a.textContent=url; a.href=url;
  buildPhaseList(); buildStage(); listenFB();
});

const gc=()=>Array.from({length:6},()=>'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'[Math.floor(Math.random()*32)]).join('');
const fmt=s=>`${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
const now=()=>new Date().toLocaleTimeString('en-AU',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
function setConn(ok){
  document.getElementById('connDot').className='cdot'+(ok?' on':'');
  document.getElementById('connLabel').textContent=ok?'Live Â· '+code:'Reconnectingâ€¦';
}
const copyCode=()=>{navigator.clipboard.writeText(code);toast('Code copied!');};
const copyURL=()=>{navigator.clipboard.writeText(`${location.origin}/participant.html?session=${code}`);toast('URL copied!');};

// â”€â”€ PHASE LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildPhaseList(){
  document.getElementById('phaseList').innerHTML=PHASES.map((p,i)=>`
    <div class="phase-item ${i===0?'active':''}" id="pi${i}" onclick="jumpPhase(${i})">
      <div class="pi-top">
        <div class="pi-num">${p.type==='reportback'?'ðŸ“¢':p.type==='synthesis'?'âœ¦':p.id}</div>
        <div class="pi-dur">${p.dur>0?Math.floor(p.dur/60)+' min':'â€”'}</div>
        <div class="pi-badge ${i===0?'live':'pending'}" id="pb${i}">${i===0?'Live':'Pending'}</div>
      </div>
      <div class="pi-sess">${p.session} Â· ${p.phase}</div>
      <div class="pi-text">${p.text}</div>
      <div class="pi-type">${p.type==='discuss'?'ðŸŽ™ Record + Themes':p.type==='reportback'?'ðŸ“¢ Record only':p.type==='synthesis'?'âœ¦ Synthesis':''}</div>
    </div>`).join('');
}

function syncPhaseList(){
  const p=PHASES[curP];
  PHASES.forEach((_,i)=>{
    document.getElementById('pi'+i).className='phase-item'+(i===curP?' active':i<curP?' done':'');
    const b=document.getElementById('pb'+i);
    b.className='pi-badge'+(i===curP?' live':i<curP?' done':' pending');
    b.textContent=i===curP?'Live':i<curP?'Done':'Pending';
  });
  document.getElementById('phTag').textContent=`${p.label} â€” ${p.session}`;
  document.getElementById('phText').textContent=p.text;
  const typeEl=document.getElementById('phTypeTag');
  typeEl.textContent=p.type==='discuss'?'Group Discussion':p.type==='reportback'?'Report Back':'Synthesis';
  typeEl.className='ph-type-tag '+p.type;
  document.getElementById('liveLabel').textContent=p.label.toUpperCase()+' LIVE';
}

// â”€â”€ STAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildStage(){
  const stage=document.getElementById('stage');
  stage.className='stage grid4';
  stage.innerHTML=[1,2,3,4].map(n=>`
    <div class="tp" id="tp${n}">
      <div class="tp-head">
        <span class="tp-tag">TABLE ${n}</span>
        <span class="tp-name" id="tpn${n}">Waitingâ€¦</span>
        <div class="tp-rdot"></div>
        <span class="tp-ts" id="tpts${n}"></span>
      </div>
      <div class="tp-body" id="tpb${n}">
        <div class="tp-empty"><div class="ico">ðŸŽ™</div><p>Waiting for recording</p></div>
      </div>
    </div>`).join('');
}

function renderPhaseStage(){
  const p=PHASES[curP];
  const stage=document.getElementById('stage');

  if(p.type==='synthesis'){
    stage.className='stage synth-view';
    stage.innerHTML=buildSynthesisView();
    return;
  }

  if(p.type==='reportback'){
    stage.className='stage rb-view';
    stage.innerHTML=`
      <div class="rb-icon">ðŸ“¢</div>
      <div class="rb-title">${p.session} â€” ${p.phase}</div>
      <div class="rb-desc">${p.instruction}<br><br>
        <strong style="color:var(--tx);">Spokesperson covers:</strong></div>
      <div class="rb-prompts">
        ${p.reportPrompts.map(rp=>`
          <div class="rb-prompt-item">
            <span class="rb-prompt-num">${rp.num}</span>
            <span class="rb-prompt-text">${rp.text}</span>
          </div>`).join('')}
      </div>
      <div style="font-family:var(--mono);font-size:.68rem;color:var(--mu2);margin-top:.25rem;">
        Recording active on participant devices Â· ~1 min per table</div>`;
    return;
  }

  // discuss phase â€” table grid
  stage.className='stage grid4';
  if(!document.getElementById('tp1')) buildStage();
  [1,2,3,4].forEach(n=>renderPanel(n));
}

// â”€â”€ TABLE PANELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPanel(n){
  const d=tdata[n][curP];
  const panel=document.getElementById('tp'+n);
  if(!panel) return;
  const body=document.getElementById('tpb'+n);
  if(!d||(!d.transcripts?.length&&!d.themes?.length&&!d.generating)){return;}
  panel.classList.add('has');
  body.innerHTML='';

  // Theme tags or spinner
  const td=document.createElement('div');
  if(d.themes?.length){
    td.innerHTML=`<div class="theme-row">${d.themes.map(t=>`<span class="ttag">${t}</span>`).join('')}</div>`;
  } else if(d.generating){
    td.innerHTML=`<div class="gen"><span class="spin">âŸ³</span> Extracting themesâ€¦</div>`;
  }
  body.appendChild(td);

  // Transcript preview
  if(d.transcripts?.length){
    const last=d.transcripts[d.transcripts.length-1];
    document.getElementById('tpts'+n).textContent=last.time;
    const id=`tx${n}p${curP}`;
    const el=document.createElement('div');
    el.innerHTML=`<div class="tp-tx" id="${id}">${last.text}</div>
      <button class="tp-more" onclick="xpnd('${id}',this)">show more â†“</button>`;
    body.appendChild(el);
  }
  updateRight();
}

function xpnd(id,btn){
  const el=document.getElementById(id);
  el.classList.toggle('exp');
  btn.textContent=el.classList.contains('exp')?'show less â†‘':'show more â†“';
}

// â”€â”€ SYNTHESIS VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSynthesisView(){
  const d1Themes=[]; // Phase 1 themes across all tables
  const d3Themes=[]; // Phase 3 themes
  const rb2Txs=[];   // Phase 2 report-back transcripts
  const rb4Txs=[];   // Phase 4 report-back transcripts

  [1,2,3,4].forEach(n=>{
    (tdata[n][0]?.themes||[]).forEach(t=>d1Themes.push({t,n}));
    (tdata[n][2]?.themes||[]).forEach(t=>d3Themes.push({t,n}));
    (tdata[n][1]?.transcripts||[]).forEach(tx=>rb2Txs.push({text:tx.text,n,time:tx.time}));
    (tdata[n][3]?.transcripts||[]).forEach(tx=>rb4Txs.push({text:tx.text,n,time:tx.time}));
  });

  const themeHTML=(arr,label)=>{
    if(!arr.length) return `<div class="no-data">No ${label} themes yet.</div>`;
    // Cluster duplicates
    const map={};
    arr.forEach(({t,n})=>{
      const k=t.toLowerCase().trim();
      if(!map[k]){map[k]={label:t,tables:[]};}
      map[k].tables.push(n);
    });
    return Object.values(map).sort((a,b)=>b.tables.length-a.tables.length)
      .map(c=>`<span class="synth-tag">${c.label}${c.tables.length>1?' ('+c.tables.length+'Ã—)':''}</span>`).join('');
  };

  const txHTML=(arr)=>{
    if(!arr.length) return '<div class="no-data">No report-back recordings yet.</div>';
    return arr.map(tx=>`<div class="synth-tx"><strong style="color:var(--mu2);font-family:var(--mono);font-size:.6rem;">Table ${tx.n} Â· ${tx.time}</strong><br>${tx.text}</div>`).join('');
  };

  return `
    <div class="synth-section">
      <h3>Session 1 Themes â€” "Where do we want to go?"</h3>
      <div class="synth-themes">${themeHTML(d1Themes,'Session 1')}</div>
      <h3 style="margin-top:.65rem;">Session 1 Report-Back Transcripts</h3>
      ${txHTML(rb2Txs)}
    </div>
    <div class="synth-section">
      <h3>Session 2 Themes â€” "How do we get to the future state?"</h3>
      <div class="synth-themes">${themeHTML(d3Themes,'Session 2')}</div>
      <h3 style="margin-top:.65rem;">Session 2 Report-Back Transcripts</h3>
      ${txHTML(rb4Txs)}
    </div>
    <div class="synth-section">
      <h3>âœ¦ Generate Collective Synthesis</h3>
      <div style="font-size:.78rem;color:var(--mu2);line-height:1.6;margin-bottom:.75rem;">
        Click below to send all themes and report-back transcripts to Claude for a collective synthesis you can present to the room.
      </div>
      <div class="synth-btn-row">
        <button class="btn pri" onclick="runSynthesis()" id="synthBtn">âœ¦ Generate Synthesis</button>
        <button class="btn" onclick="copySynthPrompt()" id="copyPromptBtn">Copy Prompt</button>
      </div>
      <div class="synth-output" id="synthOutput"></div>
    </div>`;
}

// â”€â”€ AI SYNTHESIS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSynthPrompt(){
  const lines=[];
  lines.push(`You are facilitating a strategic workshop for Queensland's food and beverage industry ecosystem.`);
  lines.push(`Four tables of participants have just completed two discussion sessions.\n`);

  // Session 1
  lines.push(`## SESSION 1: "Where do we want to go?"\n`);
  lines.push(`### Discussion Themes by Table`);
  [1,2,3,4].forEach(n=>{
    const th=tdata[n][0]?.themes||[];
    if(th.length) lines.push(`Table ${n}: ${th.join(', ')}`);
  });
  lines.push(`\n### Report-Back Transcripts (Future State 2040)`);
  [1,2,3,4].forEach(n=>{
    (tdata[n][1]?.transcripts||[]).forEach(tx=>lines.push(`Table ${n}: ${tx.text}`));
  });

  // Session 2
  lines.push(`\n## SESSION 2: "How do we get to the future state?"\n`);
  lines.push(`### Discussion Themes by Table`);
  [1,2,3,4].forEach(n=>{
    const th=tdata[n][2]?.themes||[];
    if(th.length) lines.push(`Table ${n}: ${th.join(', ')}`);
  });
  lines.push(`\n### Report-Back Transcripts (Priority Shifts & QLD Government Role)`);
  [1,2,3,4].forEach(n=>{
    (tdata[n][3]?.transcripts||[]).forEach(tx=>lines.push(`Table ${n}: ${tx.text}`));
  });

  lines.push(`\n## YOUR TASK`);
  lines.push(`Synthesise the above into a compelling 5-minute verbal presentation the facilitator can read to the room. Structure it as:`);
  lines.push(`1. **Collective vision headline** â€” one powerful sentence capturing the shared future state for 2040`);
  lines.push(`2. **3 defining features** â€” the most common themes across all tables about what that future looks like`);
  lines.push(`3. **Top 3 priority shifts** â€” what needs to change to get there (from Session 2 discussions)`);
  lines.push(`4. **The QLD Government opportunity** â€” specific roles mentioned across tables`);
  lines.push(`5. **Closing call to action** â€” one energising sentence to close the workshop`);
  lines.push(`\nWrite in warm, direct facilitation language. Keep it under 400 words. Start immediately without preamble.`);

  return lines.join('\n');
}

async function runSynthesis(){
  const btn=document.getElementById('synthBtn');
  const output=document.getElementById('synthOutput');
  if(!btn||!output) return;
  btn.textContent='âŸ³ Generatingâ€¦'; btn.disabled=true;
  output.style.display='block';
  output.textContent='Synthesising across all tables and sessionsâ€¦';

  try{
    const synthRaw = await new Promise((resolve,reject)=>{
      const xhr=new XMLHttpRequest();
      xhr.open('POST','https://api.openai.com/v1/chat/completions');
      xhr.setRequestHeader('Authorization','Bearer '+OAI);
      xhr.setRequestHeader('Content-Type','application/json');
      xhr.timeout=60000;
      xhr.onload=()=>{xhr.status===200?resolve(xhr.responseText):reject(new Error('HTTP '+xhr.status));};
      xhr.onerror=()=>reject(new Error('Network error'));
      xhr.ontimeout=()=>reject(new Error('Timeout'));
      xhr.send(JSON.stringify({model:'gpt-4o',max_tokens:800,temperature:0.5,
        messages:[{role:'user',content:buildSynthPrompt()}]}));
    });
    const data=JSON.parse(synthRaw);
    const text=data.choices?.[0]?.message?.content||'No response.';
    output.textContent=text;
    btn.textContent='â†º Regenerate'; btn.disabled=false;
    // Save to Firebase for reference
    ref.child('synthesis').set({text,generatedAt:firebase.database.ServerValue.TIMESTAMP});
  }catch(e){
    output.textContent='Error: '+e.message;
    btn.textContent='âœ¦ Try Again'; btn.disabled=false;
  }
}

function copySynthPrompt(){
  navigator.clipboard.writeText(buildSynthPrompt());
  toast('Synthesis prompt copied â€” paste into Claude.ai');
}

// â”€â”€ FIREBASE LISTENERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function listenFB(){
  ref.child('tables').on('value',snap=>{
    const t=snap.val()||{}; let c=0;
    [1,2,3,4].forEach(n=>{
      const td=t[`table${n}`]||{};
      const card=document.getElementById('tc'+n);
      const panel=document.getElementById('tp'+n);
      const isC=!!td.connected,isR=!!td.recording;
      card.className='tc'+(isR?' rec':isC?' conn':'');
      card.querySelector('.tc-s').textContent=isR?'REC':isC?'On':'â€”';
      if(panel){panel.classList.toggle('rec',isR);document.getElementById('tpn'+n).textContent=isC?'Connected':'Waitingâ€¦';}
      if(isC) c++;
    });
    document.getElementById('tcCount').textContent=`${c} / 4 connected`;
  });

  ref.child('transcripts').on('child_added',snap=>{
    const e=snap.val(); if(!e) return;
    allTx.push(e);
    const n=e.tableNumber, pi=e.phaseIndex??e.questionIndex??0;
    if(!tdata[n][pi]) tdata[n][pi]={transcripts:[],themes:[],generating:false};
    tdata[n][pi].transcripts.push({text:e.transcript,time:e.recordedAt||now()});

    // Only extract themes for discuss phases (1 and 3, index 0 and 2)
    const ph=PHASES[pi];
    if(ph?.themes){
      tdata[n][pi].generating=true;
      renderPanel(n);
      extractThemes(n,pi,e.transcript);
    } else {
      // Report-back: still render panel if in current phase
      if(pi===curP) renderPanel(n);
      // Refresh synthesis if in phase 5
      if(curP===4) renderPhaseStage();
    }
  });
}

// â”€â”€ THEME EXTRACTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function extractThemes(n,pi,transcript){
  const ph=PHASES[pi];
  try{
    const payload=JSON.stringify({model:'gpt-4o',max_tokens:200,temperature:0.3,
      messages:[{role:'user',content:`You are analysing a workshop discussion for Queensland's food & beverage ecosystem.

Question: "${ph.text}"
Table ${n} transcript: "${transcript}"

Extract 3â€“5 key themes as short 2â€“4 word labels (e.g. "Export market access", "Talent pipeline", "Regulatory burden").
Return ONLY a valid JSON array of strings. No explanation. Example: ["Theme one","Theme two"]`}]});

    // XHR instead of fetch â€” works across Chrome, Firefox and Safari
    const raw = await new Promise((resolve,reject)=>{
      const xhr=new XMLHttpRequest();
      xhr.open('POST','https://api.openai.com/v1/chat/completions');
      xhr.setRequestHeader('Authorization','Bearer '+OAI);
      xhr.setRequestHeader('Content-Type','application/json');
      xhr.timeout=30000;
      xhr.onload=()=>{
        if(xhr.status===200){resolve(xhr.responseText);}
        else{reject(new Error('HTTP '+xhr.status));}
      };
      xhr.onerror=()=>reject(new Error('Network error'));
      xhr.ontimeout=()=>reject(new Error('Timeout'));
      xhr.send(payload);
    });
    const data=JSON.parse(raw);
    const themes=JSON.parse((data.choices?.[0]?.message?.content?.trim()||'[]').replace(/```json|```/g,'').trim());
    tdata[n][pi].themes=themes;
    tdata[n][pi].generating=false;
    ref.child(`themes/table${n}/phase${pi}`).set(themes);
    renderPanel(n);
  }catch(e){
    console.error('Theme error:',e);
    if(tdata[n][pi]) tdata[n][pi].generating=false;
    renderPanel(n);
  }
}

// â”€â”€ RIGHT PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateRight(){
  const ph=PHASES[curP];
  const cross=document.getElementById('crossThemes');

  if(!ph?.themes){
    cross.innerHTML='<div class="no-data">Theme analysis runs during discussion phases (1 & 3).</div>';
  } else {
    const map={};
    [1,2,3,4].forEach(n=>{
      (tdata[n][curP]?.themes||[]).forEach(t=>{
        const k=t.toLowerCase().trim();
        if(!map[k]){map[k]={label:t,tables:[]};}
        map[k].tables.push(n);
      });
    });
    const sorted=Object.values(map).sort((a,b)=>b.tables.length-a.tables.length);
    cross.innerHTML=sorted.length
      ? sorted.map(c=>`<div class="cluster">
          <div class="cluster-name">${c.label}<span class="cluster-ct">${c.tables.length} table${c.tables.length>1?'s':''}</span></div>
          <div class="cluster-tabs">${c.tables.map(t=>`<span class="ctbadge">T${t}</span>`).join('')}</div>
        </div>`).join('')
      : '<div class="no-data">Themes will appear as tables submit recordings.</div>';
  }

  // By table â€” all phases with themes
  let html='';
  [1,2,3,4].forEach(n=>{
    const allT=[];
    [0,2].forEach(pi=>(tdata[n][pi]?.themes||[]).forEach(t=>allT.push({t,phase:pi+1})));
    if(allT.length) html+=`<div style="margin-bottom:.55rem;">
      <div style="font-family:var(--mono);font-size:.56rem;color:var(--mu2);margin-bottom:.28rem;text-transform:uppercase;letter-spacing:.1em;">Table ${n}</div>
      <div style="display:flex;flex-wrap:wrap;gap:.25rem;">${allT.map(({t,phase})=>`<span class="ttag" title="Phase ${phase}">${t}</span>`).join('')}</div>
    </div>`;
  });
  document.getElementById('byTable').innerHTML=html||'<div class="no-data">No themes yet.</div>';
}

// â”€â”€ TIMER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTimer(){
  running=!running;
  const btn=document.getElementById('startBtn');
  if(running){tInt=setInterval(tick,1000);btn.textContent='â¸ Pause';document.getElementById('liveBadge').classList.add('show');}
  else{clearInterval(tInt);btn.textContent='â–¶ Resume';}
  push();
}
function tick(){
  if(secs>0){secs--;renderTimer();if(secs%20===0)push();}
  else{
    running=false;clearInterval(tInt);
    document.getElementById('startBtn').textContent='â–¶ Start';
    push();
    const p=PHASES[curP];
    toast(`${p.label} time up!${curP<PHASES.length-1?' â†’ Advance to next phase':''}`);
  }
}
function resetTimer(){
  running=false;clearInterval(tInt);
  secs=PHASES[curP].dur||0;
  document.getElementById('startBtn').textContent='â–¶ Start';
  renderTimer();push();
}
function renderTimer(){
  const p=PHASES[curP];
  const total=p.dur||1;
  const el=document.getElementById('timerBig');
  el.textContent=fmt(secs);
  const r=secs/total;
  el.className='timer-big'+(r<=.1?' crit':r<=.25?' warn':'');
  document.getElementById('tBar').style.width=(r*100)+'%';
  // Synthesis phase has no timer
  if(p.type==='synthesis'){el.textContent='â€”';document.getElementById('tBar').style.width='100%';}
}
function push(){
  if(ref) ref.update({currentPhase:curP,timerRunning:running,secondsLeft:secs,updatedAt:firebase.database.ServerValue.TIMESTAMP});
}

function jumpPhase(i){
  if(!live) return;
  const p=PHASES[i];
  curP=i;running=false;clearInterval(tInt);
  secs=p.dur||0;
  document.getElementById('startBtn').textContent='â–¶ Start';
  document.getElementById('startBtn').disabled=p.type==='synthesis';
  document.getElementById('resetBtn').disabled=p.type==='synthesis';
  renderTimer();syncPhaseList();push();
  renderPhaseStage();
  updateRight();
}
const nextPhase=()=>{if(curP<PHASES.length-1)jumpPhase(curP+1);};
const prevPhase=()=>{if(curP>0)jumpPhase(curP-1);};

// â”€â”€ SESSION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startSession(){
  live=true; ref.update({status:'live'});
  document.getElementById('launchBtn').style.display='none';
  document.getElementById('endBtn').style.display='block';
  ['startBtn','resetBtn','nextBtn','prevBtn'].forEach(id=>document.getElementById(id).disabled=false);
  document.getElementById('liveBadge').classList.add('show');
  buildStage(); syncPhaseList(); renderTimer();
}
function endSession(){
  if(!confirm('End this session?')) return;
  running=false;clearInterval(tInt);
  ref.update({status:'ended'});
  document.getElementById('endBtn').style.display='none';
  document.getElementById('launchBtn').style.display='block';
  document.getElementById('launchBtn').textContent='â†º New Session';
  document.getElementById('liveBadge').classList.remove('show');
  toast('Session ended.');
}

// â”€â”€ EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportAll(){
  if(!allTx.length){toast('No transcripts yet.');return;}
  const lines=[`Innovation Architects â€” Workshop Transcripts`,
    `Session: ${code}  |  ${new Date().toLocaleString('en-AU')}`,'â•'.repeat(58),'',
    ...allTx.map(e=>{
      const ph=PHASES[e.phaseIndex??e.questionIndex??0];
      return `[${e.recordedAt||''}] Table ${e.tableNumber} | ${ph?ph.label+' â€” '+ph.phase:''}\n${e.transcript}\n`;
    })];
  dl(`ia-transcript-${code}.txt`,lines.join('\n'));
}
function exportThemes(){
  let lines=[`Innovation Architects â€” Theme Summary`,
    `Session: ${code}  |  ${new Date().toLocaleString('en-AU')}`,'â•'.repeat(58),''];
  [0,2].forEach(pi=>{
    const ph=PHASES[pi];
    lines.push(`\n${ph.label} â€” ${ph.text}`,'â”€'.repeat(40));
    [1,2,3,4].forEach(n=>{const th=tdata[n][pi]?.themes||[];if(th.length)lines.push(`Table ${n}: ${th.join(' Â· ')}`);});
  });
  dl(`ia-themes-${code}.txt`,lines.join('\n'));
}
const dl=(name,text)=>{const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([text],{type:'text/plain'}));a.download=name;a.click();};

function toast(msg){
  const t=document.createElement('div');
  t.style.cssText='position:fixed;bottom:1.2rem;left:50%;transform:translateX(-50%);background:#1a1635;border:1px solid rgba(139,92,246,.3);color:#ede9fe;font-family:"DM Mono",monospace;font-size:.74rem;padding:.48rem 1rem;border-radius:.35rem;z-index:999;white-space:nowrap;';
  t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),2800);
}
</script>
</body>
</html>
